<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Mini Dash</title>
<style>
body{margin:0;overflow:hidden;background:#222;font-family:sans-serif;}
canvas{display:block;margin:auto;background:#333;}
#ui,#editor,#startUI{position:absolute;color:white;font-size:18px;}
#ui{top:10px;left:10px;}
#editor{bottom:10px;left:10px;font-size:16px;}
#startUI{top:50px;left:50%;transform:translateX(-50%);}
button{font-size:16px;margin:5px;padding:5px;}
</style>
</head>
<body>
<div id="startUI">
<h2>Welcome to Mini Dash</h2>
<label>Cube Color: <input type="color" id="cubeColor" value="#4caf50"></label>
<label>Custom Sprite URL: <input type="text" id="cubeSprite" placeholder="Leave blank for cube"></label><br>
<button id="startBtn">Start Game</button>
</div>
<div id="ui"></div>
<div id="editor">
<button id="addBlockBtn">Add Blocks</button>
<button id="addSpikeBtn">Add Spikes</button>
<button id="eraseBtn">Erase</button>
<span id="editorModeText">Editor Mode</span>
</div>
<canvas id="game"></canvas>
<script>
const canvas=document.getElementById('game');
const ctx=canvas.getContext('2d');
canvas.width=900; canvas.height=400;

let gameState="start"; // start, editor, play
let cubeColor="#4caf50";
let cubeSprite=null;

document.getElementById('startBtn').onclick=()=>{
    cubeColor=document.getElementById('cubeColor').value;
    const url=document.getElementById('cubeSprite').value;
    cubeSprite=url?new Image():null;
    if(url){cubeSprite.src=url;}
    gameState="editor";
    document.getElementById('startUI').style.display='none';
    initEditor();
};

// GAME VARIABLES
let player={x:50,y:300,size:30,dy:0,gravity:0.8,jump:-15,onGround:true,mode:'cube',shield:false,doubleJump:false,fly:false};
let obstacles=[],blocks=[],portals=[],orbs=[];
let speed=5,score=0,distance=0,level=1,levelLength=5000;
let selectedTool='addBlock';

// INPUT
document.addEventListener('keydown',e=>{
    if(e.code==='Space'){
        if(player.mode==='cube'){
            if(player.onGround){player.dy=player.jump;player.onGround=false;}
            else if(player.doubleJump){player.dy=player.jump;player.doubleJump=false;}
        } else if(player.mode==='UFO'){player.dy=-7;}
    }
});
canvas.addEventListener('contextmenu',e=>e.preventDefault());
let mouseDown=false;
canvas.addEventListener('mousedown',e=>mouseDown=true);
canvas.addEventListener('mouseup',e=>mouseDown=false);

// EDITOR FUNCTIONS
function initEditor(){
    gameState='editor';
    update();
}
document.getElementById('addBlockBtn').onclick=()=>selectedTool='addBlock';
document.getElementById('addSpikeBtn').onclick=()=>selectedTool='addSpike';
document.getElementById('eraseBtn').onclick=()=>selectedTool='erase';

canvas.addEventListener('click',e=>{
    if(gameState!=='editor') return;
    const rect=canvas.getBoundingClientRect();
    const mx=e.clientX-rect.left+distance;
    const my=e.clientY-rect.top;
    if(selectedTool==='erase'){
        blocks=blocks.filter(b=>!(mx>b.x&&mx<b.x+b.w&&my>b.y&&my<b.y+b.h));
        obstacles=obstacles.filter(o=>!(mx>o.x&&mx<o.x+o.w&&my>o.y&&my<o.y+o.h));
    } else if(selectedTool==='addBlock'){
        blocks.push({x:mx,y:my,w:50,h:20,type:'safe'});
    } else if(selectedTool==='addSpike'){
        obstacles.push({x:mx,y:my,w:20,h:20,type:'spike'});
    }
});

// SAMPLE LEVELS
let levels=[
    {name:'Level 1',length:3000,blocks:[],obstacles:[],portals:[],orbs:[]},
    {name:'Level 2',length:4000,blocks:[],obstacles:[],portals:[],orbs:[]},
    {name:'Level 3',length:5000,blocks:[],obstacles:[],portals:[],orbs:[]}
];
// Auto-generate demo safe blocks & spikes
for(let i=0;i<3;i++){
    for(let x=100;x<levels[i].length;x+=220){
        levels[i].blocks.push({x:x,y:300,w:50,h:20,type:'safe'});
        if(i>0&&Math.random()<0.4) levels[i].obstacles.push({x:x+20,y:280,w:20,h:20,type:'spike'});
    }
    if(i>0) levels[i].portals.push({x:levels[i].length/2,type:'UFO',triggered:false});
    levels[i].portals.push({x:levels[i].length-100,type:'END',triggered:false});
}

// GAME LOOP
function update(){
    ctx.clearRect(0,0,canvas.width,canvas.height);
    if(gameState==='editor'){
        // DRAW BLOCKS
        blocks.forEach(b=>{
            ctx.fillStyle=(b.type==='safe')?'#555':'#f44336';
            ctx.fillRect(b.x-distance,b.y,b.w,b.h);
        });
        obstacles.forEach(o=>{
            ctx.fillStyle='#f44336';
            ctx.fillRect(o.x-distance,o.y,o.w,o.h);
        });
        ctx.fillStyle='white';
        ctx.fillText('Editor Mode: '+selectedTool,10,20);
    } else if(gameState==='play'){
        // PHYSICS
        if(player.fly){player.y+=player.dy;player.dy+=0.5;} 
        else{player.dy+=player.gravity;player.y+=player.dy;}
        if(player.y+player.size>canvas.height){player.y=canvas.height-player.size;player.dy=0;player.onGround=true;player.doubleJump=true;}
        // DRAW BLOCKS & OBSTACLES
        let currentLevel=levels[level-1];
        currentLevel.blocks.forEach(b=>{ctx.fillStyle='#555';ctx.fillRect(b.x-distance,b.y,b.w,b.h);});
        currentLevel.obstacles.forEach(o=>{ctx.fillStyle='#f44336';ctx.fillRect(o.x-distance,o.y,o.w,o.h);});
        // PORTALS
        currentLevel.portals.forEach(p=>{
            if(!p.triggered&&player.x+player.size>p.x){p.triggered=true;
                if(p.type==='UFO'){player.fly=true;player.dy=0;}
                if(p.type==='END'){level++;if(level>3){alert('You beat Mini Dash!');location.reload();}else{player.fly=false;distance=0;player.y=300;player.dy=0;}}
            }
            ctx.beginPath();ctx.arc(p.x-distance+player.x,canvas.height-50,15,0,Math.PI*2);
            ctx.fillStyle=(p.type==='UFO')?'#00f':'#0f0';ctx.fill();
        });
        // PLAYER
        ctx.fillStyle=cubeColor;
        if(cubeSprite) ctx.drawImage(cubeSprite,player.x,player.y,player.size,player.size);
        else ctx.fillRect(player.x,player.y,player.size,player.size);
        // COLLISION
        currentLevel.obstacles.forEach(o=>{
            if(player.x<o.x+o.w&&player.x+player.size>o.x&&player.y<o.y+o.h&&player.y+player.size>o.y){
                gameOver=true;alert('Game Over');location.reload();
            }
        });
        distance+=speed;score++;
        document.getElementById('ui').innerText='Level: '+level+' | Score: '+score+' | Progress: '+Math.min(100,Math.floor(distance/currentLevel.length*100))+'%';
    }
    requestAnimationFrame(update);
}

// START PLAY FUNCTION (after editor done)
function startPlay(){gameState='play';distance=0;player.y=300;player.fly=false;player.dy=0;}
</script>
</body>
</html>
